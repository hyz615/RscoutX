# Prompt 优化 + 图片对齐修复

## 更新日期
2026年1月2日

## 修改内容

### 1. ✅ AI Prompt 改为"对手侦察"视角

#### 修改目标
将 AI 分析报告从"分析自己队伍"改为**"分析对手队伍，提供针对性反制策略"**的视角。

#### 后端 Prompt 修改

**文件**: `backend/app/prompts/report_prompts.py`

##### 系统提示词（中文）
```python
REPORT_SYSTEM_PROMPT_ZH = """你是一位资深的 VEX V5 Pushback 赛事数据分析专家。
你的任务是基于提供的对手战队数据，生成详细的针对性分析报告，帮助用户了解如何应对和反制该对手队伍。

**分析视角**：
- 这是对手队伍的侦察报告，重点分析如何针对和反制
- 深入剖析对手的优势和弱点
- 提供具体的应对策略和反制方案

报告应包含:
1. 对手战队概况（基于队伍历史数据）
2. 对手机器人配置分析（分析其机器人类型的优势和弱点）
3. 对手驾驶员习惯分析（分析其驾驶风格的特点和可利用的弱点）
4. 对手比赛历史统计（了解其表现水平）
5. 对手优势与弱点（综合评估，找出突破口）
6. 针对性应对策略（如何利用对手弱点，规避其优势）
7. 对手自动赛程序分析（分析其自动赛路线，提出干扰或反制方案）
8. 具体反制方案（详细的战术建议：防守策略、进攻策略、时机把控）
```

##### 用户提示词模板（中文）
```python
REPORT_PROMPT_TEMPLATE_ZH = """请基于以下对手数据生成 VEX V5 Pushback 针对性分析报告:

## 对手战队信息
- 队号: {team_number}
- 队名: {team_name}
...

请从"如何针对该对手队伍"的角度生成一份详细的Markdown格式分析报告。
重点分析对手的优势、弱点，并提供具体的反制策略和应对方案。
```

#### 前端文案修改

**文件**: `frontend/index.html`

##### AI 导出部分标题
- **之前**: "🤖 AI 智能分析导出"
- **现在**: "🤖 AI 对手侦察分析"

##### 描述文字
```html
<p>📋 将对手的 Auton 路径图、比赛数据、机器人类型和驾驶员习惯发送给 GPT-4o 多模态模型，
生成针对性的侦察报告和反制策略。</p>
<p style="font-size: 0.9em; color: #666;">
💡 报告将从"如何针对该对手"的角度，分析其优势、弱点并提供具体的应对方案。
</p>
```

##### 按钮文字
- **之前**: "🚀 发送到 AI 分析"
- **现在**: "🚀 生成对手分析报告"

##### 报告窗口标题
- **之前**: "AI 分析报告 - 队伍 16610A"
- **现在**: "AI 针对性分析报告 - 对手 16610A"

##### 报告中的标题
- **之前**: "🎯 Auton 路径可视化"
- **现在**: "🎯 对手 Auton 路径分析"

### 2. ✅ 修复 Auton 图片向下偏移问题

#### 问题描述
在生成的 AI 报告窗口中，Auton 路径图片可能出现向下偏移的显示问题。

#### 解决方案

**文件**: `frontend/index.html` - `exportToAI()` 函数

##### CSS 修改
在报告窗口的样式中添加：
```css
.images > div { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
}

.images img { 
    width: 100%; 
    height: auto; 
    border-radius: 8px; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
    display: block;           /* 新增：块级显示 */
    vertical-align: top;      /* 新增：顶部对齐 */
}
```

##### 修改说明
1. **`display: block`**: 将图片设置为块级元素，消除行内元素的默认间距
2. **`vertical-align: top`**: 确保图片垂直对齐在顶部，避免默认的 baseline 对齐导致的偏移
3. **`.images > div`**: 使用 flex 布局确保容器内元素居中对齐

### 3. ✅ 修复 AI 报告生成错误

#### 问题
修改代码后 AI 报告无法生成，提示 "AI 不可用"。

#### 根本原因
在 `report_generator.py` 中，当使用 `custom_context` 时，`robots` 和 `drivers` 变量未定义，
导致后续构建 JSON 时出现 `NameError`。

#### 解决方案

**文件**: `backend/app/services/llm/report_generator.py`

```python
# 在函数开始处初始化变量
robots = []
drivers = []

# If custom_context provided, use it directly
if custom_context:
    combined_info = custom_context
else:
    # Get robot info from database
    # ... 查询数据库，填充 robots 和 drivers 列表
```

通过在函数开始时初始化 `robots = []` 和 `drivers = []`，确保变量始终存在，
避免在使用 custom_context 时出现未定义变量错误。

## 预期效果

### AI 报告内容变化

#### 之前
```markdown
# 队伍分析报告 - 16610A

## 1. 战队概况
该队伍表现良好...

## 2. 机器人配置分析
使用 sbot 类型机器人，具有良好的稳定性...

## 3. 驾驶员习惯分析
驾驶员偏好进攻型打法...
```

#### 现在
```markdown
# 对手侦察报告 - 16610A

## 1. 对手战队概况
该对手队伍在本赛季表现强劲，需要重点关注...

## 2. 对手机器人配置分析
**优势**: 对手使用 sbot 类型机器人，具有良好的推力和稳定性
**弱点**: sbot 转向速度较慢，可利用快速移动进行干扰
**应对建议**: 使用灵活机器人进行侧面干扰，避免正面对抗

## 3. 对手驾驶员习惯分析
**习惯特点**: 
- 偏好进攻型打法，喜欢快速抢球
- 擅长最后20秒进攻，需警惕后期发力

**可利用弱点**:
- 进攻过于激进时容易失去防守位置
- 可在前期建立优势，迫使对手冒险进攻

## 7. 对手自动赛程序分析
对手绘制了 3 条 Auton 路径，显示其自动赛策略为...

**反制方案**:
1. 自动赛阶段可采用干扰路线，阻断其关键得分点
2. 预判其移动路径，提前占据有利位置
3. 如果对手自动赛得分较高，需在手动赛加强进攻弥补分差

## 8. 具体反制方案
**防守策略**:
- 前期保持防守态势，等待对手失误
- 重点防守中场区域，限制其移动空间

**进攻策略**:
- 利用速度优势快速得分
- 避免与对手机器人正面碰撞

**时机把控**:
- 前90秒：稳健得分，建立优势
- 最后30秒：警惕对手发力，保持防守
```

### 视觉效果改进

#### Auton 图片显示
- **之前**: 图片可能向下偏移，与标题不对齐
- **现在**: 图片顶部对齐，显示整齐美观

#### 布局优化
```
┌─────────────────────────────────────┐
│ 🎯 对手 Auton 路径分析               │
├─────────────┬─────────────┬─────────┤
│  [图片1]    │  [图片2]    │  [图片3]│  ← 图片顶部对齐
│  Auton 1    │  Auton 2    │  Auton 3│  ← 标题居中
└─────────────┴─────────────┴─────────┘
```

## 测试建议

### 1. 测试 AI 报告生成
1. 搜索对手队伍（如 16610A）
2. 选择机器人类型和驾驶员习惯标签
3. 绘制 Auton 路径
4. 点击"生成对手分析报告"
5. 检查报告内容是否从"对手"角度分析
6. 验证是否包含反制策略和应对建议

### 2. 测试图片对齐
1. 生成包含多条 Auton 的报告
2. 检查图片是否顶部对齐
3. 验证图片与标题之间没有异常间距
4. 确认不同浏览器显示一致

### 3. 测试 AI 功能可用性
1. 确保后端 OpenAI API 配置正确
2. 验证报告可以正常生成（不报错）
3. 检查报告内容是否符合预期

## 文件修改清单

### 后端
- ✅ `backend/app/prompts/report_prompts.py` - 系统提示词和用户提示词
- ✅ `backend/app/services/llm/report_generator.py` - 修复变量未定义错误

### 前端
- ✅ `frontend/index.html` - AI 导出部分文案和 CSS 样式

## 回滚方案

如果需要恢复到之前的版本，修改以下内容：

1. 将 prompt 中的"对手"改回"战队"
2. 将"反制"、"应对"改回"分析"、"建议"
3. 删除图片 CSS 中的 `display: block` 和 `vertical-align: top`

## 注意事项

1. **后端需要重启**: 修改 Python 代码后需要重启后端服务器
2. **前端需要刷新**: 修改 HTML 后需要刷新浏览器页面
3. **OpenAI API**: 确保 API key 配置正确且有余额
4. **浏览器兼容性**: CSS 修改在现代浏览器中均支持
