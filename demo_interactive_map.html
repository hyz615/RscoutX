<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Path Drawing Demo - RscoutX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .mode-switch {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .mode-switch label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .mode-switch input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }
        
        button {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        #mapCanvas {
            border: 3px solid #667eea;
            border-radius: 12px;
            cursor: crosshair;
            max-width: 100%;
            display: block;
            background: #1a1a1a;
        }
        
        .tip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        .points-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
        }
        
        .point-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .point-item .delete-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .message.success { background: #48bb78; }
        .message.error { background: #f56565; }
        .message.info { background: #4299e1; }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border-radius: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Interactive Path Drawing</h1>
        <p class="subtitle">VEX Pushback Robot Path Visualization Tool</p>
        
        <div class="grid">
            <!-- Left Panel: Controls -->
            <div class="panel">
                <h2>‚öôÔ∏è Configuration</h2>
                
                <div class="form-group">
                    <label>Rendering Method</label>
                    <select id="renderMethod">
                        <option value="polyline">Polyline (ÊäòÁ∫ø)</option>
                        <option value="bezier">Bezier Curve (Ë¥ùÂ°ûÂ∞îÊõ≤Á∫ø)</option>
                        <option value="spline" selected>Spline (Ê†∑Êù°Êõ≤Á∫ø)</option>
                        <option value="astar">A* Pathfinding</option>
                        <option value="heatline">Heatline (ÁÉ≠ÂäõÁ∫ø)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Robot State</label>
                    <select id="robotState">
                        <option value="">None (Êó†Áä∂ÊÄÅ)</option>
                        <option value="idle">‚≠ï Idle (ÂæÖÊú∫)</option>
                        <option value="moving">üîµ Moving (ÁßªÂä®)</option>
                        <option value="intaking">üü¢ Intaking (Âê∏Âèñ)</option>
                        <option value="wingpushing">üü† Wing Pushing (Êé®Áøº)</option>
                        <option value="releasing">üü° Releasing (ÈáäÊîæ)</option>
                    </select>
                </div>
                
                <div class="mode-switch">
                    <label>
                        <input type="radio" name="inputMode" value="click" checked>
                        üñ±Ô∏è Click Mode
                    </label>
                    <label>
                        <input type="radio" name="inputMode" value="manual">
                        ‚å®Ô∏è Manual
                    </label>
                </div>
                
                <div id="manualInputs" style="display: none;">
                    <div class="form-group">
                        <label>X Coordinate</label>
                        <input type="number" id="pathX" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label>Y Coordinate</label>
                        <input type="number" id="pathY" placeholder="100">
                    </div>
                    <button class="btn-primary" onclick="addManualPoint()">Add Point</button>
                </div>
                
                <button class="btn-danger" onclick="clearPoints()">üóëÔ∏è Clear All Points</button>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="showLabels" checked>
                        Show Labels
                    </label>
                    <label>
                        <input type="checkbox" id="showArrows">
                        Show Arrows
                    </label>
                </div>
                
                <button class="btn-success" onclick="renderFinalPath()">‚ú® Render Path</button>
                
                <h3 style="margin-top: 30px; color: #667eea;">üìç Path Points</h3>
                <div id="pointsList" class="points-list"></div>
                
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="pointCount">0</div>
                        <div class="stat-label">Points</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stateCount">0</div>
                        <div class="stat-label">States</div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Map -->
            <div class="panel">
                <h2>üó∫Ô∏è Field Map</h2>
                <div class="tip">
                    üí° Click on the map below to add path points! Select a robot state first for automatic labeling.
                </div>
                <canvas id="mapCanvas" width="600" height="600"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        let points = [];
        let currentMode = 'click';
        
        // State colors
        const stateColors = {
            'idle': '#808080',
            'moving': '#1E90FF',
            'intaking': '#00FF00',
            'wingpushing': '#FF4500',
            'releasing': '#FFD700'
        };
        
        // Initialize
        function init() {
            drawGrid();
            
            canvas.addEventListener('click', handleCanvasClick);
            document.querySelectorAll('input[name="inputMode"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    currentMode = document.querySelector('input[name="inputMode"]:checked').value;
                    document.getElementById('manualInputs').style.display = 
                        currentMode === 'manual' ? 'block' : 'none';
                });
            });
            
            updateStats();
        }
        
        function drawGrid() {
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, 600, 600);
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 600; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, 600);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(600, i);
                ctx.stroke();
            }
            
            ctx.fillStyle = '#fff';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('VEX Pushback Field', 300, 280);
            ctx.font = '16px Arial';
            ctx.fillText('Click to add path points', 300, 320);
        }
        
        function handleCanvasClick(e) {
            if (currentMode !== 'click') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = Math.round((e.clientX - rect.left) * (canvas.width / rect.width));
            const y = Math.round((e.clientY - rect.top) * (canvas.height / rect.height));
            
            const state = document.getElementById('robotState').value;
            const point = { x, y };
            if (state) {
                point.robot_state = { state };
            }
            
            points.push(point);
            redraw();
            updatePointsList();
            updateStats();
            showMessage(`Point ${points.length} added at (${x}, ${y})`, 'success');
        }
        
        function addManualPoint() {
            const x = parseInt(document.getElementById('pathX').value);
            const y = parseInt(document.getElementById('pathY').value);
            
            if (isNaN(x) || isNaN(y)) {
                showMessage('Please enter valid coordinates', 'error');
                return;
            }
            
            const state = document.getElementById('robotState').value;
            const point = { x, y };
            if (state) {
                point.robot_state = { state };
            }
            
            points.push(point);
            redraw();
            updatePointsList();
            updateStats();
            
            document.getElementById('pathX').value = '';
            document.getElementById('pathY').value = '';
            showMessage(`Point ${points.length} added`, 'success');
        }
        
        function redraw() {
            drawGrid();
            
            if (points.length === 0) return;
            
            // Draw path connections
            if (points.length > 1) {
                ctx.strokeStyle = '#FF0000';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Draw points
            points.forEach((point, index) => {
                const color = point.robot_state ? 
                    (stateColors[point.robot_state.state] || '#FFFFFF') : '#FFFFFF';
                
                // Draw point
                ctx.fillStyle = color;
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(point.x, point.y, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                
                // Draw number
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(index + 1, point.x, point.y);
                
                // Draw state label
                if (point.robot_state) {
                    ctx.fillStyle = '#000';
                    const text = point.robot_state.state;
                    ctx.font = '12px Arial';
                    const metrics = ctx.measureText(text);
                    const width = metrics.width + 10;
                    ctx.fillRect(point.x - width/2, point.y - 28, width, 16);
                    ctx.fillStyle = color;
                    ctx.fillText(text, point.x, point.y - 20);
                }
            });
        }
        
        function updatePointsList() {
            const list = document.getElementById('pointsList');
            const stateEmojis = {
                'idle': '‚≠ï',
                'moving': 'üîµ',
                'intaking': 'üü¢',
                'wingpushing': 'üü†',
                'releasing': 'üü°'
            };
            
            list.innerHTML = points.map((p, i) => {
                const stateText = p.robot_state ? 
                    ` ${stateEmojis[p.robot_state.state]} ${p.robot_state.state}` : '';
                return `
                    <div class="point-item">
                        <span><strong>#${i+1}</strong> (${p.x}, ${p.y})${stateText}</span>
                        <button class="delete-btn" onclick="removePoint(${i})">√ó</button>
                    </div>
                `;
            }).join('');
        }
        
        function removePoint(index) {
            points.splice(index, 1);
            redraw();
            updatePointsList();
            updateStats();
            showMessage('Point removed', 'info');
        }
        
        function clearPoints() {
            points = [];
            redraw();
            updatePointsList();
            updateStats();
            showMessage('All points cleared', 'info');
        }
        
        function updateStats() {
            document.getElementById('pointCount').textContent = points.length;
            const stateCount = points.filter(p => p.robot_state).length;
            document.getElementById('stateCount').textContent = stateCount;
        }
        
        async function renderFinalPath() {
            if (points.length < 2) {
                showMessage('Need at least 2 points', 'error');
                return;
            }
            
            const method = document.getElementById('renderMethod').value;
            const showLabels = document.getElementById('showLabels').checked;
            const showArrows = document.getElementById('showArrows').checked;
            
            try {
                showMessage('Rendering...', 'info');
                
                const response = await fetch('http://localhost:8000/api/path/render/image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method,
                        points,
                        coordinate_system: 'pixel',
                        style: {
                            color: '#FF0000',
                            width: 3,
                            opacity: 0.8,
                            arrow: showArrows,
                            show_state_labels: showLabels,
                            state_icon_size: 20
                        }
                    })
                });
                
                if (!response.ok) throw new Error('Render failed');
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                // Open in new window
                const win = window.open('', '_blank');
                win.document.write(`
                    <html>
                    <head><title>Rendered Path</title></head>
                    <body style="margin:0; background:#1a1a1a; display:flex; justify-content:center; align-items:center; min-height:100vh;">
                        <img src="${url}" style="max-width:90%; border:3px solid #667eea; border-radius:10px;">
                    </body>
                    </html>
                `);
                
                showMessage('Path rendered successfully!', 'success');
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }
        
        function showMessage(text, type = 'info') {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            document.body.appendChild(msg);
            
            setTimeout(() => {
                msg.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
